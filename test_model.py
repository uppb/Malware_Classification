import tensorflow as tf
import settings
import numpy as np

from model import cnn,cnn_attention
from sklearn.metrics import precision_score, recall_score, f1_score, accuracy_score

parameters = settings.get_parameters()
path = parameters["project_path"]
test_dataset_dir = parameters["test_save_path"]
checkpoint_path = parameters["checkpoint_path"]
batch_size=settings.batch_size

test_ds = tf.data.experimental.load(test_dataset_dir)
input_shape = tf.shape(test_ds.take(1).get_single_element()[0])
test_ds = test_ds.batch(batch_size,num_parallel_calls=tf.data.AUTOTUNE)
test_ds = test_ds.prefetch(tf.data.AUTOTUNE)

test_model = cnn_attention(input_shape)
test_model.summary()
test_model.load_weights(checkpoint_path)
y_prob = test_model.predict(test_ds,verbose=1)
y_classes = y_prob.argmax(axis=-1)
temp = [a[1] for a in test_ds.as_numpy_iterator()]
y_true = []
for i in temp:
    for a in i:
        y_true.append(a)
y_true = np.asarray(y_true)
y_true = y_true[:-9]
y_classes = y_classes[:-9]
print("Precision: ",precision_score(y_true, y_classes, average = "weighted"))
print("Recall: ",recall_score(y_true, y_classes, average = "weighted"))
print("F1: ",f1_score(y_true, y_classes, average = "weighted"))
print("Accuracy: ",accuracy_score(y_true, y_classes))